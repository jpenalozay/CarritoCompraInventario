services:
  # ========================================
  # CASSANDRA
  # ========================================
  cassandra:
    image: cassandra:4.1
    container_name: ecommerce-cassandra
    hostname: cassandra
    ports:
      - "9042:9042"
      - "7199:7199"
    environment:
      - CASSANDRA_CLUSTER_NAME=EcommerceCluster
      - CASSANDRA_DC=datacenter1
      - CASSANDRA_RACK=rack1
      - MAX_HEAP_SIZE=512M
      - HEAP_NEWSIZE=100M
      - CASSANDRA_NUM_TOKENS=16
      - CASSANDRA_SEEDS=cassandra
      - CASSANDRA_START_NATIVE_TRANSPORT=true
      - CASSANDRA_START_RPC=true
    volumes:
      - cassandra-data:/var/lib/cassandra
      - ./cassandra/schemas:/opt/cassandra/schemas:ro
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "cqlsh -e 'describe cluster'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped

  # ========================================
  # REDIS CACHE CLUSTER
  # ========================================
  redis:
    image: redis:7-alpine
    container_name: ecommerce-redis
    hostname: redis
    ports:
      - "6379:6379"  # Redis default port
    command: >
      redis-server 
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --appendfsync everysec
      --save 900 1 300 10 60 10000
      --tcp-keepalive 300
      --timeout 0
      --tcp-backlog 511
      --databases 16
    environment:
      - REDIS_PASSWORD=ecommerce123  # Opcional para desarrollo
      - REDIS_PORT=6379
    volumes:
      # Persistent storage para durabilidad
      - redis-data:/data
      
      # Configuration file (opcional)
      - ./redis/config/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # ========================================
  # REDIS COMMANDER (Web UI para Redis)
  # ========================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: redis-commander
    hostname: redis-commander
    ports:
      - "8081:8081"
    environment:
      - REDIS_HOSTS=local:redis:6379
      - REDIS_PASSWORD=ecommerce123
      - HTTP_USER=admin
      - HTTP_PASSWORD=admin123
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ecommerce-network
    restart: unless-stopped

  # ========================================
  # CASSANDRA WEB UI
  # ========================================
  cassandra-web:
    image: ipushc/cassandra-web
    container_name: cassandra-web-ui
    ports:
      - "3000:3000"
    environment:
      - CASSANDRA_HOST=cassandra
      - CASSANDRA_PORT=9042
      - CASSANDRA_USER=cassandra
      - CASSANDRA_PASSWORD=cassandra
    depends_on:
      cassandra:
        condition: service_healthy
    networks:
      - ecommerce-network
    restart: unless-stopped

networks:
  ecommerce-network:
    driver: bridge

volumes:
  cassandra-data:
    driver: local
  redis-data:
    driver: local